{%- extends "base-web.html" %}

{%- block custom_headers %}
{%- if stats.trends %}
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load("visualization", "1", {packages:["corechart"]});
        google.setOnLoadCallback(drawChart);
        
        var series = [
                    {%- for status in stats.trends.year.status -%}
                    {%- if status == "processing" %}
                    {color: '#3366cc'} {#- blue #}
                    {%- elif status == "pending" %}
                    {color: '#ff9900'} {#- orange #}
                    {%- elif status == "failure" %}
                    {color: '#dc3912'} {#- red #}
                    {%- elif status == "success" %}
                    {color: '#109618'} {#- green #}
                    {%- else %}
                    {}
                    {%- endif %}
                    {%- if not loop.last %},{%- endif %}
                    {%- endfor %}
        ];
        
        function drawChart() {
        {%- if stats.trends.year %}
            /*
             * Start code to draw last year's chart
             */
            
            // Populate the data table with last year's tasks
            var data_tasks_year = new google.visualization.DataTable(
                {
                    cols: [
                            {id: 'added_on', label: 'Added on', type: 'string'},
                            {%- for status in stats.trends.year.status %}
                            {id: '{{status}}', label: '{{status|title}}', type: 'number'}{%- if not loop.last %},{%- endif %}
                            {%- endfor %}
                        ],
                    rows: [
                            {%- if stats.trends.year.timestamps %}
                            {%- for timestamp in stats.trends.year.timestamps %}
                            {c:[
                                {v: '{{timestamp|timestampformat('%B')}}'},
                                {%- for status in stats.trends.year.status %}
                                {v: {{stats.trends.year[status].get(timestamp, 0)}}}{%- if not loop.last %},{%- endif %}
                                {%- endfor %}
                            ]}{%- if not loop.last %},{%- endif %}
                            {%- endfor %}
                            {%- endif %}
                        ]
                }
            );

            // Set some options to change the graph layout
            var options_tasks_year = {
                chartArea: {top: '30', left: '80', width: "100%"},
                vAxis: {viewWindowMode: 'explicit', viewWindow: {min: '0'}},
                legend: {position: 'bottom'},
                series: series,
                isStacked: true,
            };
            
            // Draw the graph into its container (div id "graph_tasks_year")
            var graph_tasks_year = new google.visualization.ColumnChart(document.getElementById('graph_tasks_year'));
            graph_tasks_year.draw(data_tasks_year, options_tasks_year);
        {%- endif %}
        
        {%- if stats.trends.month %}
            /*
             * Start code to draw last month's chart
             */
            
            // Populate the data table with last month's tasks
            var data_tasks_month = new google.visualization.DataTable(
                {
                    cols: [
                            {id: 'added_on', label: 'Added on', type: 'string'},
                            {%- for status in stats.trends.month.status %}
                            {id: '{{status}}', label: '{{status|title}}', type: 'number'}{%- if not loop.last %},{%- endif %}
                            {%- endfor %}
                        ],
                    rows: [
                            {%- if stats.trends.month.timestamps %}
                            {%- for timestamp in stats.trends.month.timestamps %}
                            {c:[
                                {v: '{{timestamp|timestampformat('%d %B')}}' },
                                {%- for status in stats.trends.month.status %}
                                {v: {{stats.trends.month[status].get(timestamp, 0)}}}{%- if not loop.last %},{%- endif %}
                                {%- endfor %}
                            ]}{%- if not loop.last %},{%- endif %}
                            {%- endfor %}
                            {%- endif %}
                        ]
                }
            );

            // Set some options to change the graph layout
            var options_tasks_month = {
                chartArea: {top: '30', left: '80', width: "100%"},
                vAxis: {viewWindowMode: 'explicit', viewWindow: {min: '0'}},
                legend: {position: 'bottom'},
                series: series,
                isStacked: true
            };
            
            // Draw the graph into its container (div id "graph_tasks_month")
            var graph_tasks_month = new google.visualization.ColumnChart(document.getElementById('graph_tasks_month'));
            graph_tasks_month.draw(data_tasks_month, options_tasks_month);
        {%- endif %}
        
        {%- if stats.trends.day %}
            /*
             * Start code to draw last day's chart
             */
            
            // Populate the data table with last day's tasks
            var data_tasks_day = new google.visualization.DataTable(
                {
                    cols: [
                            {id: 'added_on', label: 'Added on', type: 'string'},
                            {%- for status in stats.trends.day.status %}
                            {id: '{{status}}', label: '{{status|title}}', type: 'number'}{%- if not loop.last %},{%- endif %}
                            {%- endfor %}
                        ],
                    rows: [
                            {%- if stats.trends.day.timestamps %}
                            {%- for timestamp in stats.trends.day.timestamps %}
                            {c:[
                                {v: '{{timestamp|timestampformat('%H:00')}}' },
                                {%- for status in stats.trends.day.status %}
                                {v: {{stats.trends.day[status].get(timestamp, 0)}}}{%- if not loop.last %},{%- endif %}
                                {%- endfor %}
                            ]}{%- if not loop.last %},{%- endif %}
                            {%- endfor %}
                            {%- endif %}
                        ]
                }
            );

            // Set some options to change the graph layout
            var options_tasks_day = {
                chartArea: {top: '30', left: '80', width: "100%"},
                vAxis: {viewWindowMode: 'explicit', viewWindow: {min: '0'}},
                legend: {position: 'bottom'},
                series: series,
                isStacked: true,
            };
            
            // Draw the graph into its container (div id "graph_tasks_day")
            var graph_tasks_day = new google.visualization.ColumnChart(document.getElementById('graph_tasks_day'));
            graph_tasks_day.draw(data_tasks_day, options_tasks_day);
        {%- endif %}
        }
    </script>
{%- endif %}
{%- endblock %}

{%- block content %}
    <div class="tasks">
        {%- if stats %}
        {%- if stats.machines %}
        <div class="page-header">
            <h3>Machines</h3>
        </div>
        <table class="table table-striped table-bordered">
            <tbody>
                <tr>
                    <th style="min-width: 150px; width: 150px;">Total machines:</th>
                    <td>
                        <strong>{{stats.machines.total|length()}}</strong>
                    </td>
                </tr>
                <tr>
                    <th>Free:</th>
                    <td>
                        <strong>{{stats.machines.free|length()}}/{{stats.machines.total|length()}}</strong>
                            {%- if stats.machines.free %} ({{stats.machines.free|join(", ", attribute="label")}}){%- endif %}
                    </td>
                </tr>
                <tr>
                    <th>Busy:</th>
                    <td>
                        <strong>{{stats.machines.busy|length()}}/{{stats.machines.total|length()}}</strong>
                            {%- if stats.machines.busy %} ({{stats.machines.busy|join(", ")}}){%- endif %}
                    </td>
                </tr>
            </tbody>
        </table>
        {%- endif %}
        
        {%- if stats.tasks %}
        <div class="page-header">
            <h3>Tasks</h3>
        </div>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th style="min-width: 150px; width: 150px;">&nbsp;</th>
                    <th style="width: 20%;">Overall</th>
                    <th style="width: 20%;">Last 6 months</th>
                    <th style="width: 20%;">Last 3 months</th>
                    <th style="width: 20%;">Last month</th>
                    <th style="width: 20%;">Last week</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Total tasks:</th>
                    <td>
                        <strong>{{stats.tasks.overall.total}}</strong>
                    </td>
                    <td>
                        <strong>{{stats.tasks.six_months.total}}</strong>
                    </td>
                    <td>
                        <strong>{{stats.tasks.three_months.total}}</strong>
                    </td>
                    <td>
                        <strong>{{stats.tasks.one_month.total}}</strong>
                    </td>
                    <td>
                        <strong>{{stats.tasks.one_week.total}}</strong>
                    </td>
                </tr>
                <tr>
                    <th>Successful:</th>
                    <td>
                        {%- if stats.tasks.overall.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.overall.success / stats.tasks.overall.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.six_months.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.six_months.success / stats.tasks.six_months.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.three_months.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.three_months.success / stats.tasks.three_months.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.one_month.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.one_month.success / stats.tasks.one_month.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.one_week.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.one_week.success / stats.tasks.one_week.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                </tr>
                <tr>
                    <th>Failed:</th>
                    <td>
                        {%- if stats.tasks.overall.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.overall.failure / stats.tasks.overall.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.six_months.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.six_months.failure / stats.tasks.six_months.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.three_months.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.three_months.failure / stats.tasks.three_months.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.one_month.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.one_month.failure / stats.tasks.one_month.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                    <td>
                        {%- if stats.tasks.one_week.total > 0 %}
                            <strong>{{"%.1f" %(100.0 * stats.tasks.one_week.failure / stats.tasks.one_week.total)}}&#37;</strong>
                        {%- else %}
                            <strong>0&#37;</strong>
                        {%- endif %}
                    </td>
                </tr>
                <tr>
                    <th>In queue:</th>
                    <td colspan="5">
                        <strong>{{stats.tasks.overall.processing + stats.tasks.overall.pending}}</strong>
                    </td>
                </tr>
                <tr>
                    <th>Processing:</th>
                    <td colspan="5">
                        <strong>{{stats.tasks.overall.processing}}/{{stats.tasks.overall.processing + stats.tasks.overall.pending}}</strong>
                    </td>
                </tr>
                <tr>
                    <th>Pending:</th>
                    <td colspan="5">
                        <strong>{{stats.tasks.overall.pending}}/{{stats.tasks.overall.processing + stats.tasks.overall.pending}}</strong>
                    </td>
                </tr>
            </tbody>
        </table>
        {%- endif %}

        {%- if stats.trends %}
        <div class="page-header">
            <h3>Graphs</h3>
        </div>
        
        <div>
            <h4>Last Year</h4>
            <div id="graph_tasks_year" style="width:100&#37;; height:400px;"></div>
        </div>
        <hr class="bs-docs-separator">
        <div>
            <h4>Last Month</h4>
            <div id="graph_tasks_month" style="width:100&#37;; height:400px;"></div>
        </div>
        <hr class="bs-docs-separator">
        <div>
            <h4>Last Day</h4>
            <div id="graph_tasks_day" style="width:100&#37;; height:400px;"></div>
        </div>
        {%- endif %}
        
        {%- else %}
        <div class="alert alert-error" style="text-align: center;font-size: 16px;">
            <strong>OOPS!</strong> Some error occurred. Please check your database and try again.
        </div>
        {%- endif %}
    </div>
{%- endblock %}