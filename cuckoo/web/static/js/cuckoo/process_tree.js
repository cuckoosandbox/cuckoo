"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function parseProcessData(e){return e?JSON.parse(e.text()):{}}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),Tree=function(){function e(t,a){_classCallCheck(this,e),this.el=t,this.index=a,t.attr("data-tree-initialized",!0),this.setup()}return _createClass(e,[{key:"setup",value:function(){var e=this;this.el.find('[data-tree="toggle"]').bind("click",function(t){t.stopPropagation(),e.toggleBranch($(t.currentTarget))}),this.el.addClass("open")}},{key:"toggleBranch",value:function(e){var t=e.closest("li").children("ul");t.toggleClass("open"),e.toggleClass("is-open",t.hasClass("open"))}},{key:"toggleAll",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.el.find('[data-tree="toggle"]');t.closest("li").children("ul").toggleClass("open",e),t.toggleClass("is-open",e)}}]),e}(),PaginationBar=function(){function e(t){_classCallCheck(this,e),this.config=$.extend({container:null,currentPage:1,totalPages:40,display:20,onPaginate:function(){return this}},t),this.$=null,this.render()}return _createClass(e,[{key:"render",value:function(){function e(e){var a=$("<li />"),i=$("<a />");return i.text(e),e==t.currentPage&&i.addClass("active"),isNaN(e)||i.attr("href","page:"+e),a.append(i)}var t=this.config,a=$("<ul />");a.append(e(1)),t.currentPage-10>2&&a.append(e("..."));for(var i=Math.max(2,t.currentPage-10),n=Math.min(t.totalPages,t.currentPage+10),s=i;s<=n;s++){var r=e(s);a.append(r)}return t.currentPage+10<t.totalPages&&(a.append(e("...")),a.append(e(t.totalPages))),t.container?(t.container.html(a),void this.bind(t.container)):a}},{key:"bind",value:function(e){var t=this;e.find("a[href]").bind("click",function(e){e.preventDefault();var a=$(this).attr("href").replace("page:","");t.goto(a)}),this.$=e}},{key:"goto",value:function(e){this.config.currentPage=parseInt(e),this.render(),this.config.onPaginate(e)}},{key:"destroy",value:function(){this.$.empty()}}]),e}(),ProcessBehaviorView=function(){function e(t){_classCallCheck(this,e),this._$=t,this._tree=new Tree(this._$.find(".tree"),0),this._table=null,this._bar=null,this._tags=this._$.find(".process-spec--tags"),this._loader=null,this._sticky=null,this._search=this._$.find(".process-tree__search"),this._tree.toggleAll(!0),this._$.find(".loading").length&&(this._loader=new Loader(this._$.find(".loading"),{animate:!0,duration:300}),this._loader.stop()),this.currentPage=1,this.currentPid=null,this.isLoadingSearch=!1,this.initialise()}return _createClass(e,[{key:"initialise",value:function(){var e=this;this._$.find(".process-tree__header--right").bind("click",function(e){e.preventDefault();var t=$(e.currentTarget);t.parents(".process-tree__tree, .process-tree__detail").toggleClass("open")}),this._tree.el.find('[data-toggle="tooltip"]').tooltip({tooltipClass:"cuckoo-tooltip tree-tip",position:{my:"left+20 top-20"},show:{effect:"fade",duration:100},hide:{effect:"fade",duration:100}}),this._tree.el.find("[data-load]").bind("click",function(t){t.preventDefault(),e.loadChunk($(this).data("load")),e.populate($(this).find("script")),e._tags.children().removeClass("active"),$(t.currentTarget).closest(".processes").find(".selected").removeClass("selected"),$(t.currentTarget).closest("div").addClass("selected"),e._search.find("input").val("")}),this._tags.find('[href^="filter:"]').bind("click",function(t){t.preventDefault(),e._bar&&e._bar.destroy(),e.loadChunk(e.currentPid,$(this).attr("href").split(":")[1]),$(this).parent().find("a").removeClass("active"),$(this).addClass("active")}),this._search.find("button").bind("click",function(t){e.search(e._search.find("input").val())}),this._search.find("input").bind("keypress",function(t){13==t.which&&e.search(e._search.find("input").val())});var t=this._tree.el.find("li:first > [data-load]");t&&this._tree.el.find("li:first > [data-load]").trigger("click")}},{key:"loadChunk",value:function(e,t){if(!this.isLoadingSearch){var a=this,i="";a.currentPid=e,i=t?"/analysis/filtered/"+window.task_id+"/"+e+"/"+t+"/":"/analysis/chunk/"+window.task_id+"/"+e+"/"+this.currentPage+"/",i.length&&(this._loader.start(),$.get(i,function(e){a._loader.stop(function(){a.renderTable(e),a._tags.show()})}))}}},{key:"search",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=this;if(!this.isLoadingSearch)if(window.task_id&&e){this.isLoadingSearch=!0,this._$.addClass("searching"),this._search.find("button").addClass("loading"),this._tree.el.find(".selected").removeClass("selected");var a="/analysis/search/"+window.task_id+"/";$.post(a,{search:e}).done(function(a){t.isLoadingSearch=!1,t._search.find("button").removeClass("loading"),t._$.find('[data-placeholder="process-detail-name"]').html('<span><i class="fa fa-search"></i> '+e+"</span>"),t._$.find(".process-spec--name table").hide(),t._tags.hide(),t._$.find(".process-tree__tree").removeClass("open"),t._$.removeClass("searching"),t.renderTable(a,!0)})}else console.error("Task ID and query required for searching. Aborting search.")}},{key:"populate",value:function(e){var t=parseProcessData(e);this._$.find('[data-placeholder="process-detail-pid"]').text(t.pid),this._$.find('[data-placeholder="process-detail-ppid"]').text(t.ppid),this._$.find('[data-placeholder="process-detail-name"]').text(t.name),this._$.find(".process-spec--name table").show(),this.renderBar(t.pid,1)}},{key:"renderTable",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=this,i=$.parseHTML(e)[0];t&&(i=$(i).find("table"),i.addClass("behavior-search-results"));var n=$(i).find("thead th").length,s=$(i).find("tbody").children(),r=null;$(i).removeClass("table table-bordered"),$(i).addClass("cuckoo-table"),0==s.length&&(r=$('<tr>\n                        <td colspan="'+n+'" class="no-result">\n                          <p>No results</p>\n                          <button class="button">Reset filter</button>\n                        </td>\n                      </tr>'),$(i).append(r),r.find("button").bind("click",function(){a.currentPid&&(a._tags.find(".active").removeClass("active"),a.loadChunk(a.currentPid))})),this._$.find("#behavior-table").html(i),this._$.find(".loaded").slideDown(),this._$.find(".unloaded").hide(),t&&(this._bar&&this._bar.destroy(),i.find("[data-represent]").bind("click",function(e){e.preventDefault(),$(e.currentTarget).toggleClass("collapsed"),$(e.currentTarget).closest("table").find('[data-belongs-to="'+$(e.currentTarget).data("represent")+'"]').toggleClass("hidden")})),Sticky&&(this._sticky&&this._sticky.unstick(),this._sticky=new Sticky({el:$(i).find("thead"),parent:$(".flex-nav__body"),offset:$("#primary-nav").height()+20})),this._table=i}},{key:"renderBar",value:function(e,t){var a=this;this.currentPage=t,this._bar&&this._bar.destroy(),this._bar=new PaginationBar({totalPages:window.PROCESS_TREE_PAGINATION_INFO[e],container:a._$.find(".process-spec--pagination"),onPaginate:function(t){a.currentPage=t,a.loadChunk(e)}})}}]),e}();$(function(){if($("#behavior-process-tree").length){new ProcessBehaviorView($("#behavior-process-tree"))}});
//# sourceMappingURL=process_tree.js.map
