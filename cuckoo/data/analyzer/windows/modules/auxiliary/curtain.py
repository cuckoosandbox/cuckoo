import logging, os, time, threading

from lib.common.abstracts import Auxiliary
from lib.common.results import upload_to_host

log = logging.getLogger(__name__)

__author__  = "Jeff White [karttoon] @noottrak"
__email__   = "jwhite@paloaltonetworks.com"
__version__ = "1.0.2"
__date__    = "18JAN2018"

class Curtain(threading.Thread, Auxiliary):

    def collectLogs(self):

        try:
            os.system("C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -ep bypass -enc ZgB1AG4AYwB0AGkAbwBuACAAVwByAGkAdABlAE8AdQB0AHAAdQB0ACAAKAAgACQAbQBzAGcAIAApACAAewANAAoACQAkAG0AcwBnACAAfAAgAE8AdQB0AC0ARgBpAGwAZQAgACIAQwA6AFwAYwB1AHIAdABhAGkAbgAuAGwAbwBnACIAIAAtAEEAcABwAGUAbgBkADsADQAKAH0AOwANAAoAJABlAHYAZQBuAHQAcwAgAD0AIABHAGUAdAAtAFcAaQBuAEUAdgBlAG4AdAAgAC0ARgBpAGwAdABlAHIASABhAHMAaABUAGEAYgBsAGUAIABAAHsATABvAGcATgBhAG0AZQA9ACcATQBpAGMAcgBvAHMAbwBmAHQALQBXAGkAbgBkAG8AdwBzAC0AUABvAHcAZQByAFMAaABlAGwAbAAvAE8AcABlAHIAYQB0AGkAbwBuAGEAbAAnADsAIABJAGQAPQAnADQAMQAwADQAJwB9ADsADQAKACQAcABpAGQAcwAgAD0AIABAAHsAfQA7AA0ACgBGAG8AcgBFAGEAYwBoACAAKAAgACQAZQBsAGUAbQBlAG4AdAAgAGkAbgAgACQAZQB2AGUAbgB0AHMAIAApACAAewANAAoACQBJAGYAIAAoACAAIQAkAHAAaQBkAHMALgBDAG8AbgB0AGEAaQBuAHMASwBlAHkAKAAkAGUAbABlAG0AZQBuAHQALgBQAHIAbwBjAGUAcwBzAEkAZAApACAAKQAgAHsADQAKAAkACQAkAHAAaQBkAHMAWwAkAGUAbABlAG0AZQBuAHQALgBQAHIAbwBjAGUAcwBzAEkAZABdACAAPQAgAEAAKAApADsADQAKAAkAfQA7AA0ACgAJACQAbQBlAHMAcwBhAGcAZQAgAD0AIAAkAGUAbABlAG0AZQBuAHQALgBtAGUAcwBzAGEAZwBlAC4AUwBwAGwAaQB0ACgAWwBFAG4AdgBpAHIAbwBuAG0AZQBuAHQAXQA6ADoATgBlAHcATABpAG4AZQApADsADQAKAAkAJABtAGUAcwBzAGEAZwBlACAAPQAgACQAbQBlAHMAcwBhAGcAZQBbADEALgAuACgAJABtAGUAcwBzAGEAZwBlAC4ATABlAG4AZwB0AGgAKQBdADsADQAKAAkAJABtAGUAcwBzAGEAZwBlACAAPQAgACQAbQBlAHMAcwBhAGcAZQAgAC0ASgBvAGkAbgAgAFsARQBuAHYAaQByAG8AbgBtAGUAbgB0AF0AOgA6AE4AZQB3AEwAaQBuAGUAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwA7AA0ACgAJACQAcABpAGQAcwBbACQAZQBsAGUAbQBlAG4AdAAuAFAAcgBvAGMAZQBzAHMASQBkAF0AIAArAD0AIAAkAG0AZQBzAHMAYQBnAGUAOwANAAoAfQA7AA0ACgBGAG8AcgBFAGEAYwBoACAAKAAgACQAawBlAHkAIABpAG4AIAAkAHAAaQBkAHMALgBLAGUAeQBzACAAKQAgAHsACQANAAoACQBXAHIAaQB0AGUATwB1AHQAcAB1AHQAIAAoACIAIwBTAFQAQQBSAFQAUABJAEQAIAB7ADAAfQAjACIAIAAtAGYAIAAkAGsAZQB5ACkAOwANAAoACQBGAG8AcgBFAGEAYwBoACAAKAAgACQAZQBuAHQAcgB5ACAAaQBuACAAJABwAGkAZABzAFsAJABrAGUAeQBdACAAKQAgAHsADQAKAAkACQBXAHIAaQB0AGUATwB1AHQAcAB1AHQAIAAoACIAIwBTAFQAQQBSAFQATQBFAFMAUwBBAEcARQBTAEUAQwBUAEkATwBOACMAIgApADsADQAKAAkACQBXAHIAaQB0AGUATwB1AHQAcAB1AHQAIAAoACIAewAwAH0AIgAgAC0AZgAgACQAZQBuAHQAcgB5ACkAOwANAAoACQAJAFcAcgBpAHQAZQBPAHUAdABwAHUAdAAgACgAIgAjAEUATgBEAE0ARQBTAFMAQQBHAEUAUwBFAEMAVABJAE8ATgAjACIAKQA7AA0ACgAJAH0AOwANAAoAfQA7AA0ACgANAAoA")
        except Exception as e:
            log.error("Curtain - Error collecting PowerShell events - %s " % e)

        time.sleep(5)

        if os.path.exists("C:\\curtain.log"):
            upload_to_host("C:\\curtain.log", "curtain/%s.curtain.log" % time.time())
        else:
            log.error("Curtain log file not found!")

    def clearLogs(self):

        try:
            os.system("C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -ep bypass -enc UAByAG8AYwBlAHMAcwAgAHsAIABbAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4ARQB2AGUAbgB0AGkAbgBnAC4AUgBlAGEAZABlAHIALgBFAHYAZQBuAHQATABvAGcAUwBlAHMAcwBpAG8AbgBdADoAOgBHAGwAbwBiAGEAbABTAGUAcwBzAGkAbwBuAC4AQwBsAGUAYQByAEwAbwBnACgAIgBNAGkAYwByAG8AcwBvAGYAdAAtAFcAaQBuAGQAbwB3AHMALQBQAG8AdwBlAHIAUwBoAGUAbABsAC8ATwBwAGUAcgBhAHQAaQBvAG4AYQBsACIAKQAgAH0A")
        except Exception as e:
            log.error("Curtain - Error clearing PowerShell events - %s" % e)

    def run(self):

        self.clearLogs()

        while self.do_run:

            self.collectLogs()

            time.sleep(15)

        return True

    def stop(self):

        self.collectLogs()

        return True

    def __init__(self, options={}, analyzer=None):
        threading.Thread.__init__(self)
        Auxiliary.__init__(self, options, analyzer)
        self.do_run = True
