import logging
import os
import time
from lib.common.abstracts import Auxiliary
from lib.common.results import upload_to_host

log = logging.getLogger(__name__)

__author__  = "Jeff White [karttoon] @noottrak"
__email__   = "jwhite@paloaltonetworks.com"
__version__ = "1.0.0"
__date__    = "15NOV2017"

class Curtain(Auxiliary):

    def start(self):
        log.info("Starting Curtain auxiliary module")
        return True

    def stop(self):
        log.info("Stopping Curtain auxiliary module")
        try:
            os.system("C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -ep bypass -enc ZgB1AG4AYwB0AGkAbwBuACAAVwByAGkAdABlAE8AdQB0AHAAdQB0ACAAKAAgACQAbQBzAGcAIAApACAAewANAAoACQAkAG0AcwBnACAAfAAgAE8AdQB0AC0ARgBpAGwAZQAgACIAQwA6AFwAYwB1AHIAdABhAGkAbgAuAGwAbwBnACIAIAAtAEEAcABwAGUAbgBkADsADQAKAH0AOwANAAoAJABlAHYAZQBuAHQAcwAgAD0AIABHAGUAdAAtAFcAaQBuAEUAdgBlAG4AdAAgAC0ARgBpAGwAdABlAHIASABhAHMAaABUAGEAYgBsAGUAIABAAHsATABvAGcATgBhAG0AZQA9ACcATQBpAGMAcgBvAHMAbwBmAHQALQBXAGkAbgBkAG8AdwBzAC0AUABvAHcAZQByAFMAaABlAGwAbAAvAE8AcABlAHIAYQB0AGkAbwBuAGEAbAAnADsAIABJAGQAPQAnADQAMQAwADQAJwB9ADsADQAKACQAcABpAGQAcwAgAD0AIABAAHsAfQA7AA0ACgBGAG8AcgBFAGEAYwBoACAAKAAgACQAZQBsAGUAbQBlAG4AdAAgAGkAbgAgACQAZQB2AGUAbgB0AHMAIAApACAAewANAAoACQBJAGYAIAAoACAAIQAkAHAAaQBkAHMALgBDAG8AbgB0AGEAaQBuAHMASwBlAHkAKAAkAGUAbABlAG0AZQBuAHQALgBQAHIAbwBjAGUAcwBzAEkAZAApACAAKQAgAHsADQAKAAkACQAkAHAAaQBkAHMAWwAkAGUAbABlAG0AZQBuAHQALgBQAHIAbwBjAGUAcwBzAEkAZABdACAAPQAgAEAAKAApADsADQAKAAkAfQA7AA0ACgAJACQAbQBlAHMAcwBhAGcAZQAgAD0AIAAkAGUAbABlAG0AZQBuAHQALgBtAGUAcwBzAGEAZwBlAC4AUwBwAGwAaQB0ACgAWwBFAG4AdgBpAHIAbwBuAG0AZQBuAHQAXQA6ADoATgBlAHcATABpAG4AZQApADsADQAKAAkAJABtAGUAcwBzAGEAZwBlACAAPQAgACQAbQBlAHMAcwBhAGcAZQBbADEALgAuACgAJABtAGUAcwBzAGEAZwBlAC4ATABlAG4AZwB0AGgAKQBdADsADQAKAAkAJABtAGUAcwBzAGEAZwBlACAAPQAgACQAbQBlAHMAcwBhAGcAZQAgAC0ASgBvAGkAbgAgAFsARQBuAHYAaQByAG8AbgBtAGUAbgB0AF0AOgA6AE4AZQB3AEwAaQBuAGUAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwA7AA0ACgAJACQAcABpAGQAcwBbACQAZQBsAGUAbQBlAG4AdAAuAFAAcgBvAGMAZQBzAHMASQBkAF0AIAArAD0AIAAkAG0AZQBzAHMAYQBnAGUAOwANAAoAfQA7AA0ACgBGAG8AcgBFAGEAYwBoACAAKAAgACQAawBlAHkAIABpAG4AIAAkAHAAaQBkAHMALgBLAGUAeQBzACAAKQAgAHsACQANAAoACQBXAHIAaQB0AGUATwB1AHQAcAB1AHQAIAAoACIAIwBTAFQAQQBSAFQAUABJAEQAIAB7ADAAfQAjACIAIAAtAGYAIAAkAGsAZQB5ACkAOwANAAoACQBGAG8AcgBFAGEAYwBoACAAKAAgACQAZQBuAHQAcgB5ACAAaQBuACAAJABwAGkAZABzAFsAJABrAGUAeQBdACAAKQAgAHsADQAKAAkACQBXAHIAaQB0AGUATwB1AHQAcAB1AHQAIAAoACIAIwBTAFQAQQBSAFQATQBFAFMAUwBBAEcARQBTAEUAQwBUAEkATwBOACMAIgApADsADQAKAAkACQBXAHIAaQB0AGUATwB1AHQAcAB1AHQAIAAoACIAewAwAH0AIgAgAC0AZgAgACQAZQBuAHQAcgB5ACkAOwANAAoACQAJAFcAcgBpAHQAZQBPAHUAdABwAHUAdAAgACgAIgAjAEUATgBEAE0ARQBTAFMAQQBHAEUAUwBFAEMAVABJAE8ATgAjACIAKQA7AA0ACgAJAH0AOwANAAoAfQA7AA0ACgANAAoA")
        except Exception:
            log.error("Error with Curtain PowerShell command")

        time.sleep(5)
        if os.path.exists("C:\\curtain.log"):
            upload_to_host("C:\\curtain.log", "curtain/curtain.log")
        else:
            log.error("Curtain log file not found!")

        return True

    def __init__(self, options={}, analyzer=None):
        Auxiliary.__init__(self, options, analyzer)
